This looks an awful lot like a regex puzzle :-(
